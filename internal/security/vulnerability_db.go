// Package security provides vulnerability database functionality.
package security

import (
	"time"
)

// CVEPattern represents a known CVE vulnerability pattern
type CVEPattern struct {
	CVEID         string
	CWEID         string
	Title         string
	Description   string
	Pattern       string
	Severity      VulnerabilityLevel
	FixSuggestion string
	PublishedDate time.Time
}

// VulnerabilityDB manages the vulnerability database
type VulnerabilityDB struct {
	patterns []CVEPattern
	lastUpdated time.Time
}

// NewVulnerabilityDB creates a new vulnerability database
func NewVulnerabilityDB() *VulnerabilityDB {
	db := &VulnerabilityDB{
		patterns: make([]CVEPattern, 0),
		lastUpdated: time.Now(),
	}
	db.loadDefaultPatterns()
	return db
}

// loadDefaultPatterns loads default vulnerability patterns
func (vdb *VulnerabilityDB) loadDefaultPatterns() {
	// Add common vulnerability patterns
	vdb.patterns = []CVEPattern{
		{
			CVEID: "CVE-2021-44228",
			CWEID: "CWE-502",
			Title: "Log4Shell - Remote Code Execution",
			Description: "Apache Log4j2 JNDI features do not protect against attacker controlled LDAP",
			Pattern: "log4j",
			Severity: Critical,
			FixSuggestion: "Upgrade to Log4j 2.17.0 or later",
			PublishedDate: time.Date(2021, 12, 10, 0, 0, 0, 0, time.UTC),
		},
		{
			CVEID: "CVE-2022-22965",
			CWEID: "CWE-94",
			Title: "Spring4Shell - Remote Code Execution",
			Description: "Spring Framework RCE via Data Binding on JDK 9+",
			Pattern: "class.module.classLoader",
			Severity: Critical,
			FixSuggestion: "Upgrade Spring Framework to 5.3.18+ or 5.2.20+",
			PublishedDate: time.Date(2022, 3, 31, 0, 0, 0, 0, time.UTC),
		},
		{
			CVEID: "CVE-2021-3156",
			CWEID: "CWE-120",
			Title: "Sudo Baron Samedit - Buffer Overflow",
			Description: "Heap-based buffer overflow in sudo",
			Pattern: "sudoedit -s",
			Severity: High,
			FixSuggestion: "Update sudo to version 1.9.5p2 or later",
			PublishedDate: time.Date(2021, 1, 26, 0, 0, 0, 0, time.UTC),
		},
		{
			CVEID: "CVE-2020-1472",
			CWEID: "CWE-330",
			Title: "Zerologon - Privilege Escalation",
			Description: "Netlogon privilege escalation vulnerability",
			Pattern: "Netlogon",
			Severity: Critical,
			FixSuggestion: "Apply Windows security updates",
			PublishedDate: time.Date(2020, 8, 11, 0, 0, 0, 0, time.UTC),
		},
		{
			CVEID: "CVE-2019-0708",
			CWEID: "CWE-416",
			Title: "BlueKeep - Remote Desktop Services RCE",
			Description: "Remote code execution vulnerability in Remote Desktop Services",
			Pattern: "rdp",
			Severity: Critical,
			FixSuggestion: "Apply Microsoft security patch KB4499175",
			PublishedDate: time.Date(2019, 5, 14, 0, 0, 0, 0, time.UTC),
		},
	}
}

// GetKnownPatterns returns all known vulnerability patterns
func (vdb *VulnerabilityDB) GetKnownPatterns() []CVEPattern {
	return vdb.patterns
}

// AddPattern adds a new vulnerability pattern
func (vdb *VulnerabilityDB) AddPattern(pattern CVEPattern) {
	vdb.patterns = append(vdb.patterns, pattern)
	vdb.lastUpdated = time.Now()
}

// SearchByCVE searches for a vulnerability by CVE ID
func (vdb *VulnerabilityDB) SearchByCVE(cveID string) *CVEPattern {
	for _, pattern := range vdb.patterns {
		if pattern.CVEID == cveID {
			return &pattern
		}
	}
	return nil
}

// SearchByCWE searches for vulnerabilities by CWE ID
func (vdb *VulnerabilityDB) SearchByCWE(cweID string) []CVEPattern {
	results := make([]CVEPattern, 0)
	for _, pattern := range vdb.patterns {
		if pattern.CWEID == cweID {
			results = append(results, pattern)
		}
	}
	return results
}

// GetCriticalVulnerabilities returns all critical vulnerabilities
func (vdb *VulnerabilityDB) GetCriticalVulnerabilities() []CVEPattern {
	results := make([]CVEPattern, 0)
	for _, pattern := range vdb.patterns {
		if pattern.Severity == Critical {
			results = append(results, pattern)
		}
	}
	return results
}

// GetCount returns the total number of patterns in the database
func (vdb *VulnerabilityDB) GetCount() int {
	return len(vdb.patterns)
}

// GetLastUpdated returns when the database was last updated
func (vdb *VulnerabilityDB) GetLastUpdated() time.Time {
	return vdb.lastUpdated
}

// UpdatePatterns updates the vulnerability patterns (would fetch from external source)
func (vdb *VulnerabilityDB) UpdatePatterns() error {
	// In a real implementation, this would fetch from NVD or similar
	vdb.lastUpdated = time.Now()
	return nil
}
