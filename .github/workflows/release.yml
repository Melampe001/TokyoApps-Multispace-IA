name: ðŸ“¦ Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Build all platforms
        run: |
          mkdir -p bin
          
          # Linux amd64
          GOOS=linux GOARCH=amd64 go build -o bin/tokyo-ia-linux-amd64 ./cmd/main.go
          GOOS=linux GOARCH=amd64 go build -o bin/registry-api-linux-amd64 ./cmd/registry-api/main.go
          GOOS=linux GOARCH=amd64 go build -o bin/elite-linux-amd64 ./cmd/elite/main.go
          GOOS=linux GOARCH=amd64 go build -o bin/ai-api-linux-amd64 ./cmd/ai-api/main.go
          
          # Linux arm64
          GOOS=linux GOARCH=arm64 go build -o bin/tokyo-ia-linux-arm64 ./cmd/main.go
          GOOS=linux GOARCH=arm64 go build -o bin/registry-api-linux-arm64 ./cmd/registry-api/main.go
          GOOS=linux GOARCH=arm64 go build -o bin/elite-linux-arm64 ./cmd/elite/main.go
          GOOS=linux GOARCH=arm64 go build -o bin/ai-api-linux-arm64 ./cmd/ai-api/main.go
          
          # macOS amd64
          GOOS=darwin GOARCH=amd64 go build -o bin/tokyo-ia-darwin-amd64 ./cmd/main.go
          GOOS=darwin GOARCH=amd64 go build -o bin/registry-api-darwin-amd64 ./cmd/registry-api/main.go
          GOOS=darwin GOARCH=amd64 go build -o bin/elite-darwin-amd64 ./cmd/elite/main.go
          GOOS=darwin GOARCH=amd64 go build -o bin/ai-api-darwin-amd64 ./cmd/ai-api/main.go
          
          # macOS arm64
          GOOS=darwin GOARCH=arm64 go build -o bin/tokyo-ia-darwin-arm64 ./cmd/main.go
          GOOS=darwin GOARCH=arm64 go build -o bin/registry-api-darwin-arm64 ./cmd/registry-api/main.go
          GOOS=darwin GOARCH=arm64 go build -o bin/elite-darwin-arm64 ./cmd/elite/main.go
          GOOS=darwin GOARCH=arm64 go build -o bin/ai-api-darwin-arm64 ./cmd/ai-api/main.go
          
          # Windows amd64
          GOOS=windows GOARCH=amd64 go build -o bin/tokyo-ia-windows-amd64.exe ./cmd/main.go
          GOOS=windows GOARCH=amd64 go build -o bin/registry-api-windows-amd64.exe ./cmd/registry-api/main.go
          GOOS=windows GOARCH=amd64 go build -o bin/elite-windows-amd64.exe ./cmd/elite/main.go
          GOOS=windows GOARCH=amd64 go build -o bin/ai-api-windows-amd64.exe ./cmd/ai-api/main.go
      
      - name: Generate checksums
        run: |
          cd bin
          sha256sum * > checksums.txt
          cat checksums.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: bin/
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-binaries
          path: bin/
      
      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## ðŸŽ‰ Tokyo-IA ${{ github.ref_name }}
            
            ### What's Changed
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸ“¦ Downloads
            Choose the binary for your platform below:
            
            - **Linux**: `tokyo-ia-linux-amd64`, `tokyo-ia-linux-arm64`
            - **macOS**: `tokyo-ia-darwin-amd64` (Intel), `tokyo-ia-darwin-arm64` (Apple Silicon)
            - **Windows**: `tokyo-ia-windows-amd64.exe`
            
            Available binaries:
            - `tokyo-ia` - Main application
            - `registry-api` - Agent Registry API server
            - `elite` - Elite Framework CLI
            - `ai-api` - AI API server
            
            ### ðŸš€ Deployment
            This release has been automatically deployed to production on Railway.
            
            ### ðŸ“Š Checksums
            See `checksums.txt` for SHA256 verification.
            
            ### Installation
            
            **Linux/macOS:**
            ```bash
            # Download the binary for your platform
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tokyo-ia-linux-amd64
            
            # Make it executable
            chmod +x tokyo-ia-linux-amd64
            
            # Move to PATH (optional)
            sudo mv tokyo-ia-linux-amd64 /usr/local/bin/tokyo-ia
            ```
            
            **Windows:**
            Download the `.exe` file and add it to your PATH.
          files: |
            bin/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-release:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha
            type=raw,value=latest
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max
          platforms: linux/amd64,linux/arm64
