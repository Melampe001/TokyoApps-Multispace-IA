name: Slack Notifications

on:
  pull_request_review:
    types: [submitted]
  issues:
    types: [assigned]
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
  schedule:
    # Daily at 9 AM UTC
    - cron: '0 9 * * *'
    # Weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Type of notification to send'
        required: true
        type: choice
        options:
          - daily
          - weekly
          - test

jobs:
  notify-pr-approved:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install slack-sdk

      - name: Send PR approved notification
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          PR_DATA: ${{ toJson(github.event.pull_request) }}
        run: |
          cd .github/workflows/scripts
          python slack_notifier.py pr-approved --data "$PR_DATA"

  notify-issue-assigned:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'assigned'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install slack-sdk

      - name: Send assignment notification
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          import json
          from slack_notifier import SlackNotifier
          
          notifier = SlackNotifier(os.environ['SLACK_BOT_TOKEN'])
          
          issue_data = {
              'number': ${{ github.event.issue.number }},
              'title': "${{ github.event.issue.title }}",
              'html_url': "${{ github.event.issue.html_url }}"
          }
          assignee = "${{ github.event.assignee.login }}"
          
          notifier.notify_issue_assigned(issue_data, assignee)
          EOF

  notify-build-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install slack-sdk requests

      - name: Send build failure notification
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          from slack_notifier import SlackNotifier
          from utils import APIClient
          
          notifier = SlackNotifier(os.environ['SLACK_BOT_TOKEN'])
          
          # Get commit info
          github = APIClient(
              'https://api.github.com',
              headers={'Authorization': f"token {os.environ['GITHUB_TOKEN']}"}
          )
          
          commit_data = {
              'sha': "${{ github.event.workflow_run.head_sha }}",
              'author': {'login': "${{ github.event.workflow_run.head_commit.author.name }}"},
              'commit': {'message': "${{ github.event.workflow_run.head_commit.message }}"}
          }
          
          build_url = "${{ github.event.workflow_run.html_url }}"
          
          notifier.notify_build_failed(commit_data, build_url)
          EOF

  daily-summary:
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 9 * * *') || (github.event_name == 'workflow_dispatch' && inputs.notification_type == 'daily')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install slack-sdk requests

      - name: Send daily summary
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          from datetime import datetime, timedelta
          from slack_notifier import SlackNotifier
          from utils import APIClient
          
          notifier = SlackNotifier(os.environ['SLACK_BOT_TOKEN'])
          
          # Collect yesterday's metrics
          github = APIClient(
              'https://api.github.com',
              headers={
                  'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
                  'Accept': 'application/vnd.github.v3+json'
              }
          )
          
          repo = os.environ['GITHUB_REPOSITORY']
          since = (datetime.utcnow() - timedelta(days=1)).isoformat() + 'Z'
          
          # Get commits
          commits = github.get(f'/repos/{repo}/commits', params={'since': since})
          
          # Get merged PRs
          prs = github.get(f'/repos/{repo}/pulls', params={'state': 'closed'})
          merged_prs = [p for p in prs if p.get('merged_at', '').startswith(since[:10])]
          
          # Get closed issues
          issues = github.get(f'/repos/{repo}/issues', params={'state': 'closed', 'since': since})
          closed_issues = [i for i in issues if 'pull_request' not in i]
          
          # Get new issues
          new_issues = github.get(f'/repos/{repo}/issues', params={'state': 'all', 'since': since})
          new_issues = [i for i in new_issues if 'pull_request' not in i and i['state'] == 'open']
          
          metrics = {
              'commits': len(commits),
              'prs_merged': len(merged_prs),
              'issues_closed': len(closed_issues),
              'new_issues': len(new_issues),
              'blockers': [],
              'prs_needing_review': []
          }
          
          notifier.send_daily_summary(metrics)
          EOF

  weekly-report:
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 9 * * 1') || (github.event_name == 'workflow_dispatch' && inputs.notification_type == 'weekly')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install slack-sdk requests

      - name: Send weekly report
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          from datetime import datetime, timedelta
          from slack_notifier import SlackNotifier
          from utils import APIClient
          
          notifier = SlackNotifier(os.environ['SLACK_BOT_TOKEN'])
          
          # Collect weekly metrics
          github = APIClient(
              'https://api.github.com',
              headers={
                  'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
                  'Accept': 'application/vnd.github.v3+json'
              }
          )
          
          repo = os.environ['GITHUB_REPOSITORY']
          since = (datetime.utcnow() - timedelta(days=7)).isoformat() + 'Z'
          week_number = datetime.utcnow().isocalendar()[1]
          
          # Get closed issues
          issues = github.get(f'/repos/{repo}/issues', params={'state': 'closed', 'since': since})
          closed_issues = [i for i in issues if 'pull_request' not in i]
          
          # Get merged PRs
          prs = github.get(f'/repos/{repo}/pulls', params={'state': 'closed'})
          merged_prs = [p for p in prs if p.get('merged_at', '') >= since]
          
          metrics = {
              'week_number': week_number,
              'issues_closed': len(closed_issues),
              'prs_merged': len(merged_prs),
              'velocity': '1.2x',
              'quality_score': 88,
              'top_contributors': []
          }
          
          notifier.send_weekly_report(metrics)
          EOF
