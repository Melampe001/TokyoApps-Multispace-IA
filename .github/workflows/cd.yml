name: ðŸš€ CD Pipeline - Railway

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
    environment:
      name: staging
      url: https://tokyo-ia-staging.up.railway.app
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
      
      - name: Deploy to Railway Staging
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway environment staging
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          curl -f https://tokyo-ia-staging.up.railway.app/health || exit 1
        continue-on-error: true
      
      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always() && secrets.SLACK_WEBHOOK != ''
        with:
          status: ${{ job.status }}
          text: 'Staging deployment ${{ job.status }}'
          fields: repo,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
    environment:
      name: production
      url: https://tokyo-ia.up.railway.app
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
      
      - name: Deploy to Railway Production
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway environment production
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Wait for deployment
        run: sleep 60
      
      - name: Health check
        run: |
          curl -f https://tokyo-ia.up.railway.app/health || exit 1
        continue-on-error: true
      
      - name: Run smoke tests
        run: |
          curl -f https://tokyo-ia.up.railway.app/api/agents || exit 1
        continue-on-error: true
      
      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always() && secrets.SLACK_WEBHOOK != ''
        with:
          status: ${{ job.status }}
          text: 'Production deployment ${{ job.status }} - ${{ github.ref }}'
          fields: repo,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
