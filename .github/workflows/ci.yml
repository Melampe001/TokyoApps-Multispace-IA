name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  checkout:
    name: Checkout
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check if Python files exist
        id: check-python
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            echo "python_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "python_files=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run flake8
        if: steps.check-python.outputs.python_files == 'true'
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run black (check mode)
        if: steps.check-python.outputs.python_files == 'true'
        continue-on-error: true
        run: black --check --diff .

      - name: Skip linting (no Python files)
        if: steps.check-python.outputs.python_files == 'false'
        run: echo "No Python files found, skipping linting."

  test-python:
    name: Test Python
    runs-on: ubuntu-latest
    needs: lint-python
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check if tests directory exists
        id: check-tests
        run: |
          if [ -d "tests" ]; then
            echo "tests_exist=true" >> "$GITHUB_OUTPUT"
            echo "tests_dir=tests" >> "$GITHUB_OUTPUT"
          elif [ -d "test" ]; then
            echo "tests_exist=true" >> "$GITHUB_OUTPUT"
            echo "tests_dir=test" >> "$GITHUB_OUTPUT"
          else
            echo "tests_exist=false" >> "$GITHUB_OUTPUT"
            echo "tests_dir=" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Python tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: pytest ${{ steps.check-tests.outputs.tests_dir }}/ --verbose

      - name: Skip tests (no tests directory)
        if: steps.check-tests.outputs.tests_exist == 'false'
        run: echo "No tests/ directory found, skipping Python tests."

  test-nodejs:
    name: Test Node.js
    runs-on: ubuntu-latest
    needs: checkout
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if package.json exists
        id: check-package
        run: |
          if [ -f "package.json" ]; then
            {
              echo "package_exists=true"
              if [ -f "package-lock.json" ]; then
                echo "has_lockfile=true"
              else
                echo "has_lockfile=false"
              fi
              # Check if test script exists in package.json
              if grep -q '"test"' package.json; then
                echo "has_test_script=true"
              else
                echo "has_test_script=false"
              fi
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "package_exists=false"
              echo "has_lockfile=false"
              echo "has_test_script=false"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Node.js
        if: steps.check-package.outputs.package_exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ steps.check-package.outputs.has_lockfile == 'true' && 'npm' || '' }}

      - name: Install Node.js dependencies
        if: steps.check-package.outputs.package_exists == 'true'
        run: |
          if [ "${{ steps.check-package.outputs.has_lockfile }}" == "true" ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Node.js tests
        if: steps.check-package.outputs.package_exists == 'true' && steps.check-package.outputs.has_test_script == 'true'
        run: npm test

      - name: Skip Node.js tests (no test script)
        if: steps.check-package.outputs.package_exists == 'true' && steps.check-package.outputs.has_test_script == 'false'
        run: echo "No test script found in package.json, skipping Node.js tests."

      - name: Skip Node.js tests (no package.json)
        if: steps.check-package.outputs.package_exists == 'false'
        run: echo "No package.json found, skipping Node.js tests."

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test-python, test-nodejs]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build placeholder
        run: |
          echo "Build step placeholder"
          echo "Add your build commands here"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy placeholder
        run: |
          echo "Deploy step placeholder"
          echo "Add your deployment commands here"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [checkout, lint-python, test-python, test-nodejs, build]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate summary
        run: |
          {
            echo "## CI Pipeline Summary"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Checkout | ${{ needs.checkout.result }} |"
            echo "| Lint Python | ${{ needs.lint-python.result }} |"
            echo "| Test Python | ${{ needs.test-python.result }} |"
            echo "| Test Node.js | ${{ needs.test-nodejs.result }} |"
            echo "| Build | ${{ needs.build.result }} |"
            echo ""
            echo "Pipeline completed at: $(date -u)"
          } >> "$GITHUB_STEP_SUMMARY"
