# PR Agent Handler
# Automatically runs agents on pull requests

name: PR Agent Handler

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, labeled]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Runs on every PR
  lint-check:
    name: ğŸ” Lint Agent Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run lint
        run: |
          pip install black isort flake8
          echo "## ğŸ” Lint Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Black" >> $GITHUB_STEP_SUMMARY
          if black --check . 2>/dev/null; then
            echo "âœ… Code is properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some files need formatting" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### isort" >> $GITHUB_STEP_SUMMARY
          if isort --check . 2>/dev/null; then
            echo "âœ… Imports are sorted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some imports need sorting" >> $GITHUB_STEP_SUMMARY
          fi

  test-check:
    name: ğŸ§ª Test Agent Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run tests
        run: |
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
          echo "## ğŸ§ª Test Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if pytest --cov=. -v 2>/dev/null; then
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No tests found or tests completed" >> $GITHUB_STEP_SUMMARY
          fi

  security-check:
    name: ğŸ”’ Security Agent Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run security scan
        run: |
          pip install bandit safety
          
          echo "## ğŸ”’ Security Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Bandit Scan" >> $GITHUB_STEP_SUMMARY
          bandit -r . -f txt 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
          
          echo "### Dependency Check" >> $GITHUB_STEP_SUMMARY
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "âœ… Dependencies are safe" >> $GITHUB_STEP_SUMMARY
          fi

  docs-check:
    name: ğŸ“š Docs Agent Check
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'documentation')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Check documentation
        run: |
          pip install pydocstyle
          
          echo "## ğŸ“š Docs Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          pydocstyle . --ignore=D100,D101,D102,D103,D104 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "âœ… Documentation looks good" >> $GITHUB_STEP_SUMMARY

  perf-check:
    name: âš¡ Performance Agent Check
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'performance')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Check performance
        run: |
          pip install radon
          
          echo "## âš¡ Performance Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Complexity Analysis" >> $GITHUB_STEP_SUMMARY
          radon cc . -a -s 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY || echo "â„¹ï¸ No Python files to analyze" >> $GITHUB_STEP_SUMMARY

  pr-summary:
    name: ğŸ“Š Agent Summary
    runs-on: ubuntu-latest
    needs: [lint-check, test-check, security-check]
    if: always()
    steps:
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ¤– Agent Review Summary
            
            | Agent | Status |
            |-------|--------|
            | ğŸ” Lint Agent | ${{ needs.lint-check.result == 'success' ? 'âœ… Passed' : 'âš ï¸ Check needed' }} |
            | ğŸ§ª Test Agent | ${{ needs.test-check.result == 'success' ? 'âœ… Passed' : 'âš ï¸ Check needed' }} |
            | ğŸ”’ Security Agent | ${{ needs.security-check.result == 'success' ? 'âœ… Passed' : 'âš ï¸ Check needed' }} |
            
            ---
            *Automated by Agent Task System*`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
