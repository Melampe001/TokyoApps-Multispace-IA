# ============================================================================
# Tokyo-IA Advanced Pull Request Super Agents Workflow
# ============================================================================
#
# DESCRIPCIÃ“N:
# Este workflow implementa un sistema avanzado de validaciÃ³n automÃ¡tica para
# cada Pull Request, ejecutando mÃºltiples agentes en paralelo para garantizar
# calidad, seguridad y cumplimiento de estÃ¡ndares.
#
# AGENTES INCLUIDOS:
# 1. Linting y anÃ¡lisis estÃ¡tico: Go (golangci-lint), Python (black, pylint),
#    Dart (dart analyze), Shell (shellcheck)
# 2. Pruebas automÃ¡ticas: Ejecuta `make ci` para validaciÃ³n completa
# 3. Seguridad: Trivy (vulnerabilidades en cÃ³digo y dependencias),
#    Gosec (Go), Bandit (Python)
# 4. Conventional Commits: Valida formato de commits y tÃ­tulos de PR
# 5. DocumentaciÃ³n: Verifica que cambios en /lib o /internal tengan docs
# 6. Dependencias: Alerta sobre cambios en go.mod, requirements.txt, pubspec.yaml
# 7. ReviewDog: Sugerencias automÃ¡ticas de revisiÃ³n en lÃ­nea
#
# ESTRATEGIA DE EJECUCIÃ“N:
# - Jobs paralelos para mÃ¡xima eficiencia
# - Fail-fast desactivado para ver todos los problemas a la vez
# - CachÃ© de dependencias para velocidad
# - Permisos mÃ­nimos necesarios (principio de menor privilegio)
#
# EMPRESAS DE REFERENCIA:
# Basado en mejores prÃ¡cticas de Google, Microsoft, Netflix, Shopify
# ============================================================================

name: ðŸš€ PR Super Agents

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main
      - develop

# Permisos mÃ­nimos necesarios para seguridad
permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  security-events: write

# ConfiguraciÃ³n de concurrencia: cancela ejecuciones previas del mismo PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # JOB 1: ValidaciÃ³n de Commits y PR Title (Conventional Commits)
  # ==========================================================================
  # Valida que todos los commits y el tÃ­tulo del PR sigan el formato
  # de Conventional Commits (feat:, fix:, docs:, etc.)
  # ==========================================================================
  validate-commits:
    name: ðŸ“ Conventional Commits
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            El tÃ­tulo debe comenzar con mayÃºscula y ser descriptivo.
            Ejemplo: "feat: Add new feature" o "fix: Resolve bug"

      - name: Validate commit messages
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: .github/commitlint.config.js
          failOnWarnings: false
        continue-on-error: true

  # ==========================================================================
  # JOB 2: Linting y AnÃ¡lisis EstÃ¡tico - Go
  # ==========================================================================
  # Ejecuta golangci-lint para anÃ¡lisis completo del cÃ³digo Go
  # Incluye mÃºltiples linters: gofmt, govet, staticcheck, etc.
  # ==========================================================================
  lint-go:
    name: ðŸ” Lint Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m --config=.golangci.yml
        continue-on-error: false

      - name: Run go fmt check
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted. Run 'go fmt ./...'"
            gofmt -d .
            exit 1
          fi

  # ==========================================================================
  # JOB 3: Linting - Python
  # ==========================================================================
  # Ejecuta black, flake8 y pylint para cÃ³digo Python
  # ==========================================================================
  lint-python:
    name: ðŸ Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Python files
        id: check-python
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements*.txt'

      - name: Install linting tools
        if: steps.check-python.outputs.has_python == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 pylint bandit

      - name: Run black
        if: steps.check-python.outputs.has_python == 'true'
        run: |
          black --check --diff .
        continue-on-error: false

      - name: Run flake8
        if: steps.check-python.outputs.has_python == 'true'
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

  # ==========================================================================
  # JOB 4: Linting - Dart/Flutter
  # ==========================================================================
  # Ejecuta dart analyze para cÃ³digo Dart/Flutter
  # ==========================================================================
  lint-dart:
    name: ðŸŽ¯ Lint Dart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Dart files or pubspec
        id: check-dart
        run: |
          if [ -f "pubspec.yaml" ] || find . -name "*.dart" -type f | grep -q .; then
            echo "has_dart=true" >> $GITHUB_OUTPUT
          else
            echo "has_dart=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Flutter
        if: steps.check-dart.outputs.has_dart == 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        if: steps.check-dart.outputs.has_dart == 'true'
        run: |
          if [ -f "pubspec.yaml" ]; then
            flutter pub get
          fi

      - name: Run dart analyze
        if: steps.check-dart.outputs.has_dart == 'true'
        run: |
          if [ -f "pubspec.yaml" ]; then
            dart analyze --fatal-infos
          else
            echo "No pubspec.yaml found, skipping Dart analysis"
          fi

  # ==========================================================================
  # JOB 5: Linting - Shell Scripts
  # ==========================================================================
  # Ejecuta shellcheck para validar scripts de shell
  # ==========================================================================
  lint-shell:
    name: ðŸš Lint Shell
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run shellcheck
        uses: reviewdog/action-shellcheck@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          path: "."
          pattern: "*.sh"
          exclude: "./.git/*"
          fail_on_error: false

  # ==========================================================================
  # JOB 6: Pruebas AutomÃ¡ticas y CI
  # ==========================================================================
  # Ejecuta `make ci` que incluye formateo y tests
  # ==========================================================================
  test-ci:
    name: âœ… Tests & CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run make ci
        run: make ci

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-tokyo-ia
        continue-on-error: true

  # ==========================================================================
  # JOB 7: Seguridad - Gosec (Go Security Scanner)
  # ==========================================================================
  # Escanea vulnerabilidades de seguridad en cÃ³digo Go
  # ==========================================================================
  security-gosec:
    name: ðŸ”’ Gosec Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'
        continue-on-error: true

      - name: Upload Gosec results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif
        continue-on-error: true

  # ==========================================================================
  # JOB 8: Seguridad - Bandit (Python Security Scanner)
  # ==========================================================================
  # Escanea vulnerabilidades de seguridad en cÃ³digo Python
  # ==========================================================================
  security-bandit:
    name: ðŸ”’ Bandit Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Python files
        id: check-python
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        if: steps.check-python.outputs.has_python == 'true'
        run: pip install bandit[toml]

      - name: Run Bandit
        if: steps.check-python.outputs.has_python == 'true'
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f screen
        continue-on-error: true

  # ==========================================================================
  # JOB 9: Seguridad - Trivy (Vulnerabilidades en CÃ³digo y Dependencias)
  # ==========================================================================
  # Escanea vulnerabilidades en cÃ³digo fuente, dependencias y configuraciones
  # ==========================================================================
  security-trivy:
    name: ðŸ”’ Trivy Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Run Trivy for human-readable output
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

  # ==========================================================================
  # JOB 10: ValidaciÃ³n de DocumentaciÃ³n
  # ==========================================================================
  # Verifica que cambios en /lib o /internal incluyan actualizaciones en /docs
  # ==========================================================================
  validate-documentation:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for code changes without docs
        run: |
          echo "Checking if code changes require documentation updates..."
          
          # Obtener archivos modificados
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          # Verificar cambios en lib/ o internal/
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -E "^(lib/|internal/)" || true)
          DOCS_CHANGES=$(echo "$CHANGED_FILES" | grep -E "^docs/" || true)
          
          if [ -n "$CODE_CHANGES" ] && [ -z "$DOCS_CHANGES" ]; then
            echo "âš ï¸  WARNING: Se detectaron cambios en lib/ o internal/ sin actualizar docs/"
            echo ""
            echo "Archivos de cÃ³digo modificados:"
            echo "$CODE_CHANGES"
            echo ""
            echo "Por favor, considera actualizar la documentaciÃ³n en el directorio /docs"
            echo ""
            # No fallar el job, solo advertir
            exit 0
          elif [ -n "$CODE_CHANGES" ] && [ -n "$DOCS_CHANGES" ]; then
            echo "âœ… Cambios de cÃ³digo con documentaciÃ³n actualizada detectados"
          else
            echo "â„¹ï¸  No se detectaron cambios en lib/ o internal/"
          fi

      - name: Comment on PR if docs needed
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const codeFiles = files.filter(f => 
              f.filename.startsWith('lib/') || f.filename.startsWith('internal/')
            );
            const docFiles = files.filter(f => f.filename.startsWith('docs/'));
            
            if (codeFiles.length > 0 && docFiles.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âš ï¸ **Recordatorio de DocumentaciÃ³n**\n\n' +
                      'Se detectaron cambios en `lib/` o `internal/` sin actualizar `docs/`.\n' +
                      'Por favor, considera si estos cambios requieren documentaciÃ³n adicional.\n\n' +
                      'Archivos de cÃ³digo modificados:\n' +
                      codeFiles.map(f => `- ${f.filename}`).join('\n')
              });
            }
        continue-on-error: true

  # ==========================================================================
  # JOB 11: Alerta de Cambios en Dependencias
  # ==========================================================================
  # Detecta y notifica cambios en archivos de dependencias
  # ==========================================================================
  dependency-check:
    name: ðŸ“¦ Dependency Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for dependency changes
        id: dep-check
        run: |
          echo "Verificando cambios en archivos de dependencias..."
          
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          DEP_FILES="go.mod go.sum requirements.txt requirements-dev.txt setup.py pyproject.toml Pipfile pubspec.yaml pubspec.lock package.json package-lock.json yarn.lock"
          
          CHANGED_DEPS=""
          for file in $DEP_FILES; do
            if echo "$CHANGED_FILES" | grep -q "^$file$"; then
              CHANGED_DEPS="$CHANGED_DEPS $file"
            fi
          done
          
          if [ -n "$CHANGED_DEPS" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "files=$CHANGED_DEPS" >> $GITHUB_OUTPUT
            echo "âš ï¸  Se detectaron cambios en dependencias:"
            echo "$CHANGED_DEPS"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No se detectaron cambios en dependencias"
          fi

      - name: Comment on PR about dependency changes
        if: steps.dep-check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const files = '${{ steps.dep-check.outputs.files }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ“¦ **Alerta de Cambios en Dependencias**\n\n' +
                    'Se detectaron cambios en los siguientes archivos de dependencias:\n' +
                    files.split(' ').map(f => `- \`${f}\``).join('\n') + '\n\n' +
                    '**Acciones recomendadas:**\n' +
                    '- âœ… Revisar las nuevas dependencias por vulnerabilidades conocidas\n' +
                    '- âœ… Verificar compatibilidad con dependencias existentes\n' +
                    '- âœ… Actualizar documentaciÃ³n si es necesario\n' +
                    '- âœ… Considerar el impacto en el tamaÃ±o del bundle/binario\n\n' +
                    'Los escaneos de seguridad (Trivy, Gosec, Bandit) se ejecutarÃ¡n automÃ¡ticamente.'
            });

  # ==========================================================================
  # JOB 12: ReviewDog - Sugerencias AutomÃ¡ticas
  # ==========================================================================
  # Proporciona sugerencias de revisiÃ³n automÃ¡tica en el cÃ³digo
  # Usa mÃºltiples herramientas para anÃ¡lisis
  # ==========================================================================
  reviewdog:
    name: ðŸ¶ ReviewDog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run ReviewDog with golangci-lint
        uses: reviewdog/action-golangci-lint@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: warning
          fail_on_error: false
          golangci_lint_flags: "--timeout=5m"

      - name: Run ReviewDog with misspell
        uses: reviewdog/action-misspell@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: info
          locale: "US"
          exclude: |
            ./vendor/*
            ./.git/*
          fail_on_error: false

  # ==========================================================================
  # JOB 13: Summary - Resumen Final
  # ==========================================================================
  # Genera un resumen de todos los checks ejecutados
  # ==========================================================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [
      validate-commits,
      lint-go,
      lint-python,
      lint-dart,
      lint-shell,
      test-ci,
      security-gosec,
      security-bandit,
      security-trivy,
      validate-documentation,
      dependency-check,
      reviewdog
    ]
    if: always()
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jobs = [
              { name: 'Conventional Commits', status: '${{ needs.validate-commits.result }}' },
              { name: 'Go Linting', status: '${{ needs.lint-go.result }}' },
              { name: 'Python Linting', status: '${{ needs.lint-python.result }}' },
              { name: 'Dart Linting', status: '${{ needs.lint-dart.result }}' },
              { name: 'Shell Linting', status: '${{ needs.lint-shell.result }}' },
              { name: 'Tests & CI', status: '${{ needs.test-ci.result }}' },
              { name: 'Gosec Security', status: '${{ needs.security-gosec.result }}' },
              { name: 'Bandit Security', status: '${{ needs.security-bandit.result }}' },
              { name: 'Trivy Security', status: '${{ needs.security-trivy.result }}' },
              { name: 'Documentation Check', status: '${{ needs.validate-documentation.result }}' },
              { name: 'Dependency Check', status: '${{ needs.dependency-check.result }}' },
              { name: 'ReviewDog', status: '${{ needs.reviewdog.result }}' }
            ];
            
            const getEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                default: return 'âš ï¸';
              }
            };
            
            const summary = jobs.map(job => 
              `${getEmoji(job.status)} **${job.name}**: ${job.status}`
            ).join('\n');
            
            const failedJobs = jobs.filter(j => j.status === 'failure');
            
            let message = '## ðŸš€ PR Super Agents - Resumen de ValidaciÃ³n\n\n' + summary;
            
            if (failedJobs.length > 0) {
              message += '\n\n### âš ï¸ Jobs fallidos:\n' +
                        failedJobs.map(j => `- ${j.name}`).join('\n') +
                        '\n\nPor favor, revisa los logs de los jobs fallidos arriba.';
            } else {
              message += '\n\n### ðŸŽ‰ Â¡Todos los checks pasaron exitosamente!';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
