# Auto-Merge Workflow
# Automatically merges approved PRs

name: Auto-Merge

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ['Python CI/CD', 'Lint', 'Security Scan']
    types: [completed]

jobs:
  auto-merge:
    name: ðŸ”€ Auto-Merge Approved PRs
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved' || github.event.check_suite.conclusion == 'success'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check for auto-merge label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            
            if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.review) {
              prNumber = context.payload.review.pull_request_url.split('/').pop();
            } else if (context.payload.check_suite) {
              // Get PRs associated with this check suite
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.check_suite.head_branch}`
              });
              if (prs.length > 0) {
                prNumber = prs[0].number;
              }
            }
            
            if (!prNumber) {
              console.log('No PR found');
              return false;
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const hasAutoMergeLabel = pr.labels.some(l => 
              l.name === 'auto-merge' || l.name === 'automerge'
            );
            
            core.setOutput('pr_number', prNumber);
            return hasAutoMergeLabel;
            
      - name: Merge if approved and checks pass
        if: steps.check-label.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.check-label.outputs.pr_number }};
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Check if PR is mergeable
            if (!pr.mergeable) {
              console.log('PR is not mergeable');
              return;
            }
            
            // Check reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const hasApproval = reviews.some(r => r.state === 'APPROVED');
            const hasChangesRequested = reviews.some(r => r.state === 'CHANGES_REQUESTED');
            
            if (!hasApproval || hasChangesRequested) {
              console.log('PR does not have required approvals');
              return;
            }
            
            // Check status checks
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            if (status.state !== 'success' && status.total_count > 0) {
              console.log('Status checks are not passing');
              return;
            }
            
            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              
              console.log(`Successfully merged PR #${prNumber}`);
              
              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: '## ðŸŽ‰ Auto-merged!\n\nEste PR ha sido mergeado automÃ¡ticamente ya que:\n- âœ… Tiene aprobaciÃ³n\n- âœ… Todos los checks pasaron\n- âœ… Tiene la etiqueta `auto-merge`'
              });
            } catch (error) {
              console.log(`Failed to merge: ${error.message}`);
            }

  dependabot-auto-merge:
    name: ðŸ¤– Auto-merge Dependabot
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Auto-merge minor and patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
