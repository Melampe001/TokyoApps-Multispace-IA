name: Blocker Detector

# Run daily Monday-Friday at 9:00 AM UTC
on:
  schedule:
    - cron: '0 9 * * 1-5'  # 9:00 AM UTC, weekdays only
  workflow_dispatch:  # Allow manual trigger for testing

permissions:
  issues: write
  pull-requests: read

jobs:
  detect-blockers:
    runs-on: ubuntu-latest
    steps:
      - name: Detect stalled work
        id: detect-blockers
        uses: actions/github-script@v8
        with:
          script: |
            const now = new Date();
            const threeDaysAgo = new Date(now.getTime() - (3 * 24 * 60 * 60 * 1000));
            const fiveDaysAgo = new Date(now.getTime() - (5 * 24 * 60 * 60 * 1000));
            
            console.log('ðŸ” Searching for blockers...');
            console.log(`Current time: ${now.toISOString()}`);
            console.log(`3 days ago: ${threeDaysAgo.toISOString()}`);
            console.log(`5 days ago: ${fiveDaysAgo.toISOString()}`);
            
            // Detect draft PRs older than 3 days
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            const stalledDraftPRs = pullRequests.filter(pr => {
              const updatedAt = new Date(pr.updated_at);
              return pr.draft && updatedAt < threeDaysAgo;
            });
            
            console.log(`Found ${stalledDraftPRs.length} stalled draft PRs`);
            
            // Detect issues without updates for more than 5 days
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            // Filter out PRs from issues list and check for staleness
            const stalledIssues = issues.filter(issue => {
              const updatedAt = new Date(issue.updated_at);
              return !issue.pull_request && updatedAt < fiveDaysAgo;
            });
            
            console.log(`Found ${stalledIssues.length} stalled issues`);
            
            // Only create issue if there are blockers
            if (stalledDraftPRs.length === 0 && stalledIssues.length === 0) {
              console.log('âœ… No blockers found. Great job team!');
              return;
            }
            
            // Build markdown report
            let body = '# ðŸš¨ Blocker Alert\n\n';
            body += `This is an automated report of stalled work items detected on ${now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.\n\n`;
            
            if (stalledDraftPRs.length > 0) {
              body += '## ðŸ“ Stalled Draft PRs (>3 days)\n\n';
              for (const pr of stalledDraftPRs) {
                const daysStalled = Math.floor((now - new Date(pr.updated_at)) / (1000 * 60 * 60 * 24));
                body += `- **[#${pr.number}](${pr.html_url})** - ${pr.title}\n`;
                body += `  - Last updated: ${daysStalled} days ago\n`;
                body += `  - Author: @${pr.user.login}\n\n`;
              }
            }
            
            if (stalledIssues.length > 0) {
              body += '## ðŸ› Stalled Issues (>5 days)\n\n';
              for (const issue of stalledIssues) {
                const daysStalled = Math.floor((now - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24));
                body += `- **[#${issue.number}](${issue.html_url})** - ${issue.title}\n`;
                body += `  - Last updated: ${daysStalled} days ago\n`;
                body += `  - Assignees: ${issue.assignees.length > 0 ? issue.assignees.map(a => `@${a.login}`).join(', ') : 'None'}\n\n`;
              }
            }
            
            body += '---\n\n';
            body += 'ðŸ’¡ **Action Items:**\n';
            body += '- Review stalled PRs and move them forward or close them\n';
            body += '- Update stalled issues with current status or close if no longer relevant\n';
            body += '- Consider if blockers need discussion or additional resources\n\n';
            body += '_This issue was automatically generated by the Blocker Detector workflow._';
            
            // Create the blocker alert issue
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Blocker Alert - ${now.toISOString().split('T')[0]}`,
              body: body,
              labels: ['blocker-alert', 'automated']
            });
            
            console.log(`âœ… Created blocker alert issue: ${issue.html_url}`);
            
            // Store issue URL for Slack notification
            core.setOutput('issue_url', issue.html_url);
            core.setOutput('blockers_found', 'true');
            core.setOutput('draft_prs', stalledDraftPRs.length);
            core.setOutput('stalled_issues', stalledIssues.length);

      - name: Send Slack notification
        if: success() && steps.detect-blockers.outputs.blockers_found == 'true' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "ðŸš¨ Blocker Alert",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Blocker Alert Detected*\nStalled work items need attention. Check the issue for details."
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Draft PRs: ${{ steps.detect-blockers.outputs.draft_prs }}\nStalled Issues: ${{ steps.detect-blockers.outputs.stalled_issues }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Details"
                        },
                        "url": "${{ steps.detect-blockers.outputs.issue_url }}"
                      }
                    ]
                  }
                ]
              }'
            echo "Slack notification sent successfully"
          else
            echo "SLACK_WEBHOOK_URL not configured, skipping notification"
          fi
