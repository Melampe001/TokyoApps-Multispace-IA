name: ðŸš€ Preview Deployment

# Create preview deployments for pull requests
# Deploys web application to Vercel for each PR
# Comments on PR with preview URL

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'web/**'
      - 'vercel.json'
  pull_request_target:
    types: [closed]

# Minimal permissions
permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  deploy-preview:
    name: Deploy Preview to Vercel
    runs-on: ubuntu-latest
    if: github.event.action != 'closed' && github.event_name != 'pull_request_target'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./web
        run: npm ci
      
      - name: Build application
        working-directory: ./web
        run: npm run build
        env:
          # Use preview environment variables
          NODE_ENV: preview
      
      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./web
          scope: ${{ secrets.VERCEL_ORG_ID }}
          alias-domains: |
            pr-${{ github.event.pull_request.number }}-tokyoia.vercel.app
      
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.preview-url }}';
            
            // Create deployment
            const { data: deployment } = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
              environment: 'Preview',
              description: `PR #${{ github.event.pull_request.number }} preview`,
              auto_merge: false,
              required_contexts: []
            });
            
            // Update deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.id,
              state: 'success',
              environment_url: deploymentUrl,
              description: 'Preview deployment ready'
            });
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.preview-url }}';
            const pr = context.payload.pull_request;
            
            const body = `## ðŸš€ Preview Deployment Ready!
            
            Your changes have been deployed to a preview environment:
            
            **Preview URL**: ${deploymentUrl}
            
            ### ðŸ“‹ Deployment Details
            - **Environment**: Preview
            - **PR**: #${pr.number}
            - **Commit**: ${pr.head.sha.substring(0, 7)}
            - **Branch**: \`${pr.head.ref}\`
            
            ### âœ… What to check
            - Test all functionality in the preview
            - Verify UI changes render correctly
            - Check responsive design on mobile
            - Validate API integrations
            
            The preview will update automatically with new commits.
            
            ---
            ðŸ’¡ **Tip**: Preview deployments are temporary and will be cleaned up when the PR is closed.
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸš€ Preview Deployment Ready')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: body
              });
            }
      
      - name: Create step summary
        run: |
          echo "### ðŸš€ Preview Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL**: ${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY

  cleanup-preview:
    name: Clean Up Preview Deployment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Delete Vercel deployment
        uses: actions/github-script@v7
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            console.log(`Cleaning up preview deployment for PR #${prNumber}`);
            
            // Note: Vercel automatically removes preview deployments after PR closure
            // This step is here for logging and future custom cleanup logic
            
            // Comment on PR
            const body = `ðŸ§¹ Preview deployment has been cleaned up.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
