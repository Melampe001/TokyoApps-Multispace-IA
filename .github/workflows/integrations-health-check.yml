name: Integrations Health Check

on:
  schedule:
    # Every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests google-auth google-auth-httplib2 google-api-python-client slack-sdk

      - name: Check Jira connectivity
        id: jira-check
        continue-on-error: true
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          import sys
          from jira_sync_manager import JiraClient
          
          try:
              jira = JiraClient(
                  os.environ['JIRA_BASE_URL'],
                  os.environ['JIRA_USER_EMAIL'],
                  os.environ['JIRA_API_TOKEN']
              )
              
              # Test API call
              response = jira.get('/rest/api/2/myself')
              print(f"‚úÖ Jira connection successful: {response.get('displayName')}")
              sys.exit(0)
          except Exception as e:
              print(f"‚ùå Jira connection failed: {e}")
              sys.exit(1)
          EOF

      - name: Check Google Sheets access
        id: sheets-check
        continue-on-error: true
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          import sys
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          
          try:
              credentials = service_account.Credentials.from_service_account_info(
                  json.loads(os.environ['GOOGLE_CREDENTIALS']),
                  scopes=['https://www.googleapis.com/auth/spreadsheets']
              )
              
              service = build('sheets', 'v4', credentials=credentials)
              
              # Test read access
              result = service.spreadsheets().get(
                  spreadsheetId=os.environ['GOOGLE_SHEET_ID']
              ).execute()
              
              print(f"‚úÖ Google Sheets access successful: {result.get('properties', {}).get('title')}")
              sys.exit(0)
          except Exception as e:
              print(f"‚ùå Google Sheets access failed: {e}")
              sys.exit(1)
          EOF

      - name: Check Slack bot connectivity
        id: slack-check
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          import sys
          from slack_sdk import WebClient
          from slack_sdk.errors import SlackApiError
          
          try:
              client = WebClient(token=os.environ['SLACK_BOT_TOKEN'])
              
              # Test API call
              response = client.auth_test()
              print(f"‚úÖ Slack bot connection successful: {response['user']}")
              sys.exit(0)
          except SlackApiError as e:
              print(f"‚ùå Slack bot connection failed: {e}")
              sys.exit(1)
          EOF

      - name: Create health status summary
        if: always()
        run: |
          echo "## Integration Health Status" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Jira status
          if [ "${{ steps.jira-check.outcome }}" = "success" ]; then
            echo "‚úÖ **Jira**: Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Jira**: Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Google Sheets status
          if [ "${{ steps.sheets-check.outcome }}" = "success" ]; then
            echo "‚úÖ **Google Sheets**: Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Google Sheets**: Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Slack status
          if [ "${{ steps.slack-check.outcome }}" = "success" ]; then
            echo "‚úÖ **Slack**: Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Slack**: Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: steps.jira-check.outcome == 'failure' || steps.sheets-check.outcome == 'failure' || steps.slack-check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const failures = [];
            if ('${{ steps.jira-check.outcome }}' === 'failure') failures.push('Jira');
            if ('${{ steps.sheets-check.outcome }}' === 'failure') failures.push('Google Sheets');
            if ('${{ steps.slack-check.outcome }}' === 'failure') failures.push('Slack');
            
            const title = `Integration Health Check Failed: ${failures.join(', ')}`;
            const body = `## Integration Health Check Failure
            
            The following integrations are unhealthy:
            ${failures.map(f => `- ‚ùå ${f}`).join('\n')}
            
            **Timestamp:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            Please investigate and resolve the connectivity issues.
            
            [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-health,automated'
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['integration-health', 'automated', 'bug']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Health check failed again at ${new Date().toISOString()}\n\n${body}`
              });
            }

      - name: Notify Slack on failure
        if: steps.jira-check.outcome == 'failure' || steps.sheets-check.outcome == 'failure' || steps.slack-check.outcome == 'failure'
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          cd .github/workflows/scripts
          python << 'EOF'
          import os
          from slack_sdk import WebClient
          
          try:
              client = WebClient(token=os.environ['SLACK_BOT_TOKEN'])
              
              failures = []
              if '${{ steps.jira-check.outcome }}' == 'failure':
                  failures.append('Jira')
              if '${{ steps.sheets-check.outcome }}' == 'failure':
                  failures.append('Google Sheets')
              if '${{ steps.slack-check.outcome }}' == 'failure':
                  failures.append('Slack')
              
              message = f"üö® *Integration Health Alert*\n\nThe following integrations are unhealthy:\n" + \
                        '\n'.join([f"‚Ä¢ ‚ùå {f}" for f in failures])
              
              # Try to send to alerts channel
              client.chat_postMessage(
                  channel='alerts',  # Fallback to general if alerts doesn't exist
                  text=message
              )
          except Exception as e:
              print(f"Could not send Slack notification: {e}")
          EOF
