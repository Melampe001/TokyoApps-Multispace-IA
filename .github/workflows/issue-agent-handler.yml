# Issue Event Handler
# Automatically assigns agents to issues based on labels

name: Issue Agent Handler

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  assign-agent:
    name: ğŸ¤– Assign Agent to Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Assign agent based on labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name.toLowerCase());
            
            // Agent assignments based on labels
            const agentResponses = {
              'bug': 'ğŸ› **Debug Agent** has been assigned to investigate this bug.',
              'security': 'ğŸ”’ **Security Agent** has been assigned to analyze this security issue.',
              'performance': 'âš¡ **Performance Agent** has been assigned to optimize this.',
              'documentation': 'ğŸ“š **Docs Agent** has been assigned to update documentation.',
              'enhancement': 'â™»ï¸ **Refactor Agent** has been assigned to implement this enhancement.',
              'test': 'ğŸ§ª **Test Agent** has been assigned to create tests.',
              'api': 'ğŸ”Œ **API Agent** has been assigned to handle API changes.',
              'database': 'ğŸ—„ï¸ **DB Agent** has been assigned to handle database changes.'
            };
            
            let assignedAgents = [];
            for (const label of labels) {
              if (agentResponses[label]) {
                assignedAgents.push(agentResponses[label]);
              }
            }
            
            if (assignedAgents.length > 0) {
              const comment = `## ğŸ¤– Agent Assignment\n\n${assignedAgents.join('\n\n')}\n\n---\n*Automated by Agent Task System*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
            }

  handle-commands:
    name: ğŸ® Handle Agent Commands
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/')
    steps:
      - name: Check authorization
        id: auth
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login
            });
            return ['admin', 'write', 'maintain'].includes(permission.permission);
            
      - name: Process command
        if: steps.auth.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim();
            const command = comment.split(' ')[0].toLowerCase();
            
            const agentCommands = {
              '/lint': { agent: 'Lint Agent', emoji: 'ğŸ”', action: 'Running linting analysis...' },
              '/test': { agent: 'Test Agent', emoji: 'ğŸ§ª', action: 'Running tests...' },
              '/coverage': { agent: 'Coverage Agent', emoji: 'ğŸ“Š', action: 'Generating coverage report...' },
              '/security': { agent: 'Security Agent', emoji: 'ğŸ”’', action: 'Running security scan...' },
              '/docs': { agent: 'Docs Agent', emoji: 'ğŸ“š', action: 'Generating documentation...' },
              '/perf': { agent: 'Performance Agent', emoji: 'âš¡', action: 'Running performance analysis...' },
              '/debug': { agent: 'Debug Agent', emoji: 'ğŸ›', action: 'Starting debug session...' },
              '/refactor': { agent: 'Refactor Agent', emoji: 'â™»ï¸', action: 'Analyzing code for refactoring...' },
              '/api': { agent: 'API Agent', emoji: 'ğŸ”Œ', action: 'Processing API request...' },
              '/db': { agent: 'DB Agent', emoji: 'ğŸ—„ï¸', action: 'Processing database request...' },
              '/build': { agent: 'Build Agent', emoji: 'ğŸ“¦', action: 'Starting build process...' },
              '/release': { agent: 'Release Agent', emoji: 'ğŸš€', action: 'Preparing release...' },
              '/help': { agent: 'ChatOps Agent', emoji: 'â“', action: 'Showing available commands...' }
            };
            
            if (agentCommands[command]) {
              const { agent, emoji, action } = agentCommands[command];
              
              let response = `## ${emoji} ${agent}\n\n${action}\n\n`;
              
              if (command === '/help') {
                response += '### Available Commands\n\n';
                response += '| Command | Agent | Description |\n';
                response += '|---------|-------|-------------|\n';
                response += '| `/lint` | Lint Agent | Run code linting |\n';
                response += '| `/test` | Test Agent | Run tests |\n';
                response += '| `/coverage` | Coverage Agent | Show coverage report |\n';
                response += '| `/security` | Security Agent | Run security scan |\n';
                response += '| `/docs` | Docs Agent | Generate documentation |\n';
                response += '| `/perf` | Perf Agent | Performance analysis |\n';
                response += '| `/debug` | Debug Agent | Debug assistance |\n';
                response += '| `/refactor` | Refactor Agent | Code refactoring |\n';
                response += '| `/api` | API Agent | API development |\n';
                response += '| `/db` | DB Agent | Database operations |\n';
                response += '| `/build` | Build Agent | Build project |\n';
                response += '| `/release` | Release Agent | Create release |\n';
              }
              
              response += '\n---\n*Automated by Agent Task System*';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: response
              });
            }
